<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pauker - SPA Start</title>
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <div id="app-view">
      <div id="drawer-backdrop" class="drawer-backdrop"></div>

      <aside class="drawer" id="tree-drawer">
        <div id="drawer-resizer" class="drawer-resizer" aria-hidden="true"></div>
        <header class="drawer-header">
          <div class="drawer-title" id="drawer-title">DATABASE</div>
        </header>
        <div class="tree-scroll">
          <nav class="tree" id="tree-root" aria-label="Ordnerstruktur">
            <div style="padding: 1rem; color: hsl(var(--txt-muted));">Lade Ordnerstruktur...</div>
          </nav>
        </div>
      </aside>

      <main class="main-surface">
        <header class="top-bar">
          <button
            id="menu-tree-btn"
            class="menu-icon-btn"
            type="button"
            title="Ordnerstruktur ein-/ausblenden"
            aria-label="Ordnerstruktur ein-/ausblenden"
          >
            üìÅ
          </button>
          <div class="top-bar-title">Die Wiederholung ist die Mutter des Lernens</div>
          <button id="theme-toggle-app" class="theme-toggle-btn" type="button" aria-label="Theme wechseln">üåô</button>
        </header>
      </main>
    </div>

    <script>
      (function () {
        'use strict';

        const THEME_KEY = 'globalTheme_v1';
        const DRAWER_KEY = 'spaDrawerOpen_v1';
        const OPENED_KEY = 'spaOpenedFolders_v1';
        const DRAWER_WIDTH_KEY = 'spaDrawerWidth_v1';

        const appView = document.getElementById('app-view');
        const menuBtn = document.getElementById('menu-tree-btn');
        const themeToggleBtn = document.getElementById('theme-toggle-app');
        const drawerBackdrop = document.getElementById('drawer-backdrop');
        const treeDrawer = document.getElementById('tree-drawer');
        const drawerResizer = document.getElementById('drawer-resizer');
        const drawerTitleEl = document.getElementById('drawer-title');
        const treeRootEl = document.getElementById('tree-root');

        let drawerOpen = false;
        let openedFolderIds = [];
        let drawerWidth = 360;
        let rootTree = [];

        init();

        function init() {
          loadState();
          initTheme();
          applyDrawerState();

          menuBtn.addEventListener('click', toggleDrawer);
          drawerBackdrop.addEventListener('click', () => setDrawer(false));
          themeToggleBtn.addEventListener('click', toggleTheme);
          initResizer();
          applyDrawerWidth();

          initIndex();
        }

        function loadState() {
          drawerOpen = localStorage.getItem(DRAWER_KEY) === '1';

          try {
            const raw = localStorage.getItem(OPENED_KEY);
            openedFolderIds = raw ? JSON.parse(raw) : [];
            if (!Array.isArray(openedFolderIds)) openedFolderIds = [];
          } catch (_) {
            openedFolderIds = [];
          }

          const rawWidth = Number(localStorage.getItem(DRAWER_WIDTH_KEY));
          if (!Number.isNaN(rawWidth) && rawWidth > 0) {
            drawerWidth = rawWidth;
          }
        }

        function saveState() {
          localStorage.setItem(DRAWER_KEY, drawerOpen ? '1' : '0');
          localStorage.setItem(OPENED_KEY, JSON.stringify(openedFolderIds));
          localStorage.setItem(DRAWER_WIDTH_KEY, String(drawerWidth));
        }

        function toggleDrawer() {
          setDrawer(!drawerOpen);
        }

        function setDrawer(nextOpen) {
          drawerOpen = !!nextOpen;
          saveState();
          applyDrawerState();
        }

        function applyDrawerState() {
          appView.classList.toggle('tree-open', drawerOpen);
          menuBtn.classList.toggle('active', drawerOpen);
          drawerBackdrop.classList.toggle('active', drawerOpen);
        }

        function clampDrawerWidth(width) {
          const min = 240;
          const max = Math.min(window.innerWidth * 0.88, 720);
          return Math.max(min, Math.min(max, width));
        }

        function applyDrawerWidth() {
          drawerWidth = clampDrawerWidth(drawerWidth);
          treeDrawer.style.setProperty('--drawer-width', drawerWidth + 'px');
        }

        function initResizer() {
          if (!drawerResizer) return;

          let isResizing = false;

          drawerResizer.addEventListener('mousedown', () => {
            isResizing = true;
            drawerResizer.classList.add('resizing');
            document.body.style.userSelect = 'none';
            document.body.style.cursor = 'col-resize';
          });

          window.addEventListener('mousemove', (event) => {
            if (!isResizing) return;
            drawerWidth = clampDrawerWidth(event.clientX);
            applyDrawerWidth();
          });

          window.addEventListener('mouseup', () => {
            if (!isResizing) return;
            isResizing = false;
            drawerResizer.classList.remove('resizing');
            document.body.style.userSelect = '';
            document.body.style.cursor = '';
            saveState();
          });

          window.addEventListener('resize', applyDrawerWidth);
        }

        function initTheme() {
          const stored = localStorage.getItem(THEME_KEY);
          const theme = stored === 'light' ? 'light' : 'dark';
          applyTheme(theme);
        }

        function toggleTheme() {
          const isLight = document.documentElement.classList.contains('theme-light');
          const next = isLight ? 'dark' : 'light';
          applyTheme(next);
          localStorage.setItem(THEME_KEY, next);
        }

        function applyTheme(theme) {
          if (theme === 'light') {
            document.documentElement.classList.add('theme-light');
            themeToggleBtn.textContent = '‚òÄÔ∏è';
            return;
          }

          document.documentElement.classList.remove('theme-light');
          themeToggleBtn.textContent = 'üåô';
        }

        async function initIndex() {
          try {
            const response = await fetch('./index.json?ts=' + Date.now());
            if (!response.ok) throw new Error('index.json konnte nicht geladen werden');

            const payload = await response.json();
            rootTree = normalizeTree(Array.isArray(payload.tree) ? payload.tree : []);
            drawerTitleEl.textContent = String(payload.rootName || 'DATABASE').toUpperCase();

            treeRootEl.innerHTML = '';
            buildTree(treeRootEl, rootTree, 0);
          } catch (error) {
            treeRootEl.innerHTML =
              '<div style="padding: 1rem; color: hsl(var(--txt-muted));">' +
              escapeHtml(error.message) +
              '</div>';
          }
        }

        function normalizeTree(nodes) {
          const normalized = [];
          const dedupeMap = new Map();

          (Array.isArray(nodes) ? nodes : []).forEach((node) => {
            if (!node || !node.isFolder) return;

            const entries = normalizeNode(node);
            entries.forEach((entry) => {
              const key = canonicalName(entry.name);
              if (!dedupeMap.has(key)) {
                dedupeMap.set(key, entry);
                normalized.push(entry);
                return;
              }

              const existing = dedupeMap.get(key);
              existing.children = mergeChildren(existing.children, entry.children);
            });
          });

          return normalized;
        }

        function normalizeNode(node) {
          const rawName = String(node.name || '');
          const cleanedName = decodeLegacyName(rawName);
          const normalizedChildren = normalizeTree(Array.isArray(node.children) ? node.children : []);

          if (cleanedName.toLowerCase() === 'database') {
            return normalizedChildren;
          }

          if (cleanedName === 'M') {
            return normalizedChildren;
          }

          if (/\bPr$/.test(cleanedName) && normalizedChildren.length > 0) {
            return normalizedChildren;
          }

          if (isLegacyArtifact(rawName, cleanedName)) {
            return normalizedChildren;
          }

          const normalizedNode = {
            id: node.id,
            name: cleanedName,
            isFolder: true,
            children: normalizedChildren
          };

          // Repariert alte, falsch gesplittete Namensketten wie:
          // "Code-Qualit" -> "u00e4t " -> "u0026 Wartbarkeit".
          collapseNameFragments(normalizedNode);
          return [normalizedNode];
        }

        function collapseNameFragments(node) {
          while (node.children.length === 1) {
            const child = node.children[0];
            if (!child || !child.isFolder) break;
            if (!isLikelyNameFragment(child.name)) break;

            node.name = joinNameParts(node.name, child.name);
            node.children = child.children;
          }
        }

        function isLikelyNameFragment(name) {
          const value = String(name || '').trim();
          if (!value) return true;
          if (/^[&/]/.test(value)) return true;
          if (/^[√§√∂√º√ü]/i.test(value)) return true;
          return false;
        }

        function joinNameParts(left, right) {
          const a = String(left || '').trimEnd();
          const b = String(right || '').trimStart();

          if (!a) return b;
          if (!b) return a;

          if (b.startsWith('&') || b.startsWith('/')) return a + ' ' + b;
          if (/[A-Za-z√Ñ√ñ√ú√§√∂√º√ü]$/.test(a) && /^[a-z√§√∂√º√ü]/i.test(b)) return a + b;
          return a + ' ' + b;
        }

        function decodeLegacyName(raw) {
          return String(raw || '')
            .replace(/u([0-9a-fA-F]{4})/g, function (_, hex) {
              return String.fromCharCode(parseInt(hex, 16));
            })
            .replace(/\s+/g, ' ')
            .trim();
        }

        function isLegacyArtifact(rawName, cleanedName) {
          const raw = String(rawName || '').trim();
          const clean = String(cleanedName || '').trim();

          if (!raw && !clean) return true;
          // Byte-Split-Artefakte wie "303", "274fungsfallen" aus alten Pfaden ausblenden.
          if (/^[0-9]{3}([A-Za-z].*)?$/.test(raw)) return true;
          return false;
        }

        function canonicalName(value) {
          return String(value || '')
            .toLowerCase()
            .replace(/\s+/g, ' ')
            .trim();
        }

        function mergeChildren(baseChildren, addChildren) {
          const merged = [];
          const index = new Map();

          (Array.isArray(baseChildren) ? baseChildren : []).forEach((item) => {
            const key = canonicalName(item.name);
            index.set(key, item);
            merged.push(item);
          });

          (Array.isArray(addChildren) ? addChildren : []).forEach((item) => {
            const key = canonicalName(item.name);
            if (!index.has(key)) {
              index.set(key, item);
              merged.push(item);
              return;
            }

            const existing = index.get(key);
            existing.children = mergeChildren(existing.children, item.children);
          });

          return merged;
        }

        function buildTree(container, nodes, level) {
          nodes.forEach((node) => {
            if (!node || !node.isFolder) return;

            const rowNode = document.createElement('div');
            rowNode.className = 'tree-node';
            rowNode.dataset.id = node.id;

            const isCollapsed = !openedFolderIds.includes(node.id);
            rowNode.classList.toggle('tree-node--collapsed', isCollapsed);

            const row = document.createElement('div');
            row.className = 'tree-row';
            row.style.setProperty('--level', level);

            const iconButton = document.createElement('button');
            iconButton.className = 'tree-icon-button';
            iconButton.type = 'button';
            const hasChildren = Array.isArray(node.children) && node.children.length > 0;
            if (hasChildren) {
              iconButton.classList.add('is-toggleable');
              iconButton.setAttribute('aria-label', 'Ordner auf- oder zuklappen');
              iconButton.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleNode(rowNode, node.id, iconButton);
              });
            } else {
              iconButton.setAttribute('aria-hidden', 'true');
              iconButton.tabIndex = -1;
            }

            const icon = document.createElement('span');
            icon.className = 'tree-icon';
            icon.textContent = folderEmoji(hasChildren, isCollapsed);
            iconButton.appendChild(icon);
            row.appendChild(iconButton);

            const label = document.createElement('button');
            label.className = 'tree-label';
            label.type = 'button';
            label.textContent = node.name;
            label.title = node.name;
            label.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();
            });
            row.appendChild(label);

            rowNode.appendChild(row);

            const childContainer = document.createElement('div');
            childContainer.className = 'tree-children';
            if (Array.isArray(node.children) && node.children.length > 0) {
              buildTree(childContainer, node.children, level + 1);
            }
            rowNode.appendChild(childContainer);

            container.appendChild(rowNode);
          });
        }

        function toggleNode(rowNode, id, iconButton) {
          const idx = openedFolderIds.indexOf(id);
          if (idx >= 0) {
            openedFolderIds.splice(idx, 1);
            rowNode.classList.add('tree-node--collapsed');
          } else {
            openedFolderIds.push(id);
            rowNode.classList.remove('tree-node--collapsed');
          }

          const icon = iconButton && iconButton.querySelector('.tree-icon');
          if (icon) {
            icon.textContent = folderEmoji(true, !openedFolderIds.includes(id));
          }

          saveState();
        }

        function folderEmoji(hasChildren, isCollapsed) {
          if (!hasChildren) return 'üéÆ';
          return isCollapsed ? 'üìÅ' : 'üìÇ';
        }

        function escapeHtml(value) {
          return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
        }
      })();
    </script>
  </body>
</html>
